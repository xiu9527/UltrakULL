# 檔案：.github/workflows/build-1.3.1.yml
name: Build UltrakULL 1.3.1

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest
    steps:
      # ① 取回全部 tags
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0

      # ② 切到 1.3.1
      - name: Checkout 1.3.1
        run: git checkout 1.3.1

      # ③ 下載公開的 stub.zip（不需要驗證）
      - name: Download & extract stub.zip
        shell: pwsh
        run: |
          # 用 PowerShell 抓 release asset
          Invoke-WebRequest `
            -Uri "https://github.com/${{ github.repository }}/releases/download/v1.3.1/stub.zip" `
            -OutFile stub.zip

          # 建目录并解压
          New-Item -ItemType Directory -Force -Path game\ULTRAKILL_Data\Managed
          Expand-Archive -LiteralPath stub.zip -DestinationPath game\ULTRAKILL_Data\Managed


      # ④ 建立 csproj.user，設定 ULTRAKILLPath
      - name: Create csproj.user
        shell: pwsh
        run: |
          $xml = @"
          <?xml version="1.0" encoding="utf-8"?>
          <Project>
            <PropertyGroup>
              <ULTRAKILLPath>${{ github.workspace }}\game</ULTRAKILLPath>
            </PropertyGroup>
          </Project>
          "@
      
          # 輸出到檔案（UTF8 編碼）
          $xml | Out-File -FilePath UltrakULL/UltrakULL.csproj.user -Encoding utf8

      - name: 列出 game 目錄結構 & 環境變數
        shell: pwsh
        run: |
          Write-Host '=== ULTRAKILLPath =' $env:ULTRAKILLPath
          Write-Host '=== 列出 game 下所有檔案 ==='
          Get-ChildItem "${{ github.workspace }}\game" -Recurse |
            ForEach-Object { $_.FullName }
          Write-Host '=== 檢查 ManagedDir 與 BepInExCoreDir 路徑 ==='
          Write-Host "ManagedDir：" "${{ github.workspace }}\game\ULTRAKILL_Data\Managed\"
          Write-Host "BepInExCoreDir：" "${{ github.workspace }}\game\BepInEx\core\"
          
      # ⑤ 安裝 .NET SDK
      - name: Setup .NET SDK
        uses: actions/setup-dotnet@v3
        with:
          dotnet-version: '7.x'

      # ⑥ 編譯 Release
      - name: Build Release
        run: dotnet build UltrakULL.sln -c Release

      # ⑦ 上傳編譯好的 DLL
      - name: Upload DLLs
        uses: actions/upload-artifact@v4
        with:
          name: UltrakULL-1.3.1
          path: BepInEx/plugins/UltrakULL/*.dll
